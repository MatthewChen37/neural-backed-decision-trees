#!/usr/bin/env python
"""Run evaluation on a single image, using an NBDT"""

from nbdt.model import SoftNBDT, HardNBDT
from pytorchcv.models.wrn_cifar import wrn28_10_cifar10
from torchvision import transforms
import torch
from nbdt.utils import DATASET_TO_CLASSES, load_image_from_path, maybe_install_wordnet
import sys
from nbdt import models

maybe_install_wordnet()

assert len(sys.argv) > 1, "Need to pass image URL or image path as argument"

# load pretrained NBDT

model = getattr(models, 'wrn28_10_cifar10')


state_dict = torch.load("checkpoint/ckpt-NeuronData-wrn28_10_cifar10-induced-wrn28_10_cifar10-SoftTreeSupLoss.pth")['net']

print(type(state_dict))
print(type(model))

model_kwargs = {'num_classes': 2 }

model = model(**model_kwargs)




def load_state_dict(state_dict):
    try:
        model.load_state_dict(state_dict)
    except RuntimeError as e:
        if 'Missing key(s) in state_dict:' in str(e):
            model.load_state_dict({
                key.replace('module.', '', 1): value
                for key, value in state_dict.items()
            })

load_state_dict(state_dict)


        
model = SoftNBDT(
  pretrained=False,
  dataset='NeuronData',
  arch='wrn28_10_cifar10',
  hierarchy='induced-wrn28_10_cifar10',
  model=model)

# load + transform image
im = load_image_from_path(sys.argv[1])
im = im.convert('RGB')

transform = transforms.Compose([
  transforms.Resize(32),
  transforms.CenterCrop(32),
  transforms.ToTensor(),
  transforms.Normalize((0.4914, 0.4822, 0.4465), (0.2023, 0.1994, 0.2010)),
])


x = transform(im)[None]

# run inference
outputs, decisions = model.forward_with_decisions(x)  # use `model(x)` to obtain just logits
_, predicted = outputs.max(1)
cls = DATASET_TO_CLASSES['NeuronData'][predicted[0]]
print('Prediction:', cls, '// Decisions:', ', '.join([
    '{} ({:.2f}%)'.format(info['name'], info['prob'] * 100) for info in decisions[0]
][1:]))  # [1:] to skip the root
